# 5モータ同時ドライブファームウェア
対象試験:落とし戸試験  
ボード:Mega2560(EEPROMを必要とするため) または **STM32F411 (新対応)**  

## 🚀 MCU強化版 (v2.0)
### 新機能
- **STM32F411高速マイコン対応**: Mega2560から高性能STM32F411への移行
- **タイマーベース制御**: ポーリングからMarlin/grbl方式の効率的な割り込み制御へ改善
- **クロスプラットフォーム**: AVRとSTM32の両方に対応
- **向上した安全性**: リミットスイッチの即座停止機能を維持・強化

## API(GCode)
### 共通事項
XYZ系統ではなく I/J/K/L/M [mm]をモータ指定&変位量としています  
また速度指定を V/W/X/Y/Z [mm/min]としています。  
モータI[mm] -> 速度V [mm/min]  
モータM[mm] -> 速度Z [mm/min]  
例) G90 I-5 V10 -> モータIを絶対座標-5[mm]まで速度10[mm/min]で移動せよ  
例) G91 I-1 V5 -> モータIを現在座標から-1[mm]、速度5[mm/min]で移動せよ  
### G90 絶対値移動
通常のGCodeに準拠します  
### G91 インクリメンタル移動
通常のGCodeに準拠します  
### G52 ワーク位置更新
設定値を現在のワーク位置としてEEPROMに保存します  
### G17 モータ電源ON
ステッピングモータの電源をONにして  
電磁ロックを作動させます  
よほどの重荷重がかからない限り不要だと思います  
### G18 モータ電源OFF
ステッピングモータの電源をOFFにして  
電磁ロックを切ります  
### G21 バージョン情報 (新)
ファームウェアのバージョンとプラットフォーム情報を表示します

## 🔧 プラットフォーム対応

### STM32F411 (推奨)
```bash
pio run -e STM32F411
```
**ピン配置:**
- モーターI: PA0(pulse), PA1(dir), PA2(ena), PA3(max), PA4(min)
- モーターJ: PA5(pulse), PA6(dir), PA7(ena), PB0(max), PB1(min)  
- モーターK: PB10(pulse), PB11(dir), PB12(ena), PB13(max), PB14(min)
- モーターL: PB15(pulse), PC6(dir), PC7(ena), PC8(max), PC9(min)
- モーターM: PC10(pulse), PC11(dir), PC12(ena), PD2(max), PA8(min)

### Arduino Mega2560 (互換性維持)
```bash
pio run -e Mega
```
**従来ピン配置を維持**

## 🛡️ 安全機能
- **即座停止**: リミットスイッチで即時停止
- **方向制御**: 禁止側ではない方向への自由な移動
- **緊急停止**: emergency_stop()関数による即座停止
- **範囲制限**: ±50mm範囲での安全な動作

## ⚡ 性能向上
- **タイマーベース制御**: ポーリングからハードウェアタイマーへ
- **精密なタイミング**: Marlin/grbl方式の高精度ステップ制御  
- **CPU効率化**: 割り込み駆動による効率的な処理
- **応答性向上**: より高速な制御応答